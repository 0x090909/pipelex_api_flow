domain = "openapi"
description = "Retrieve openapi backend capabilities"
main_pipe = "retrieve_backend_capabilities"

[concept.ApiCapabilities]
description = "Structured object containing capabilities of the api backend."
[concept.OperationToAccomplish]
description = "a function_name and a list of parameters that represent the operation to accomplish"

[pipe.retrieve_backend_capabilities]
type = "PipeSequence"
description = "Main pipeline to api capabilities from a OpenAPI backend API."
inputs = { openapi_schema_def_link = "Text", operation_to_accomplish = "Text" }
output = "Text"
steps = [
    { pipe = "inspect_api_capabilities", result = "api_capabilities" },
    { pipe = "identify_the_operation_to_accomplish", result = "operation_to_accomplish_detail" },
]

[pipe.inspect_api_capabilities]
type = "PipeFunc"
description = "Construct the API request to retrieve markdown for the target website."
inputs = { openapi_schema_def_link = "Text" }
output = "ApiCapabilities"
function_name = "get_api_backend_capabilities"

[pipe.identify_the_operation_to_accomplish]
type = "PipeLLM"
description = "Construct the API request to retrieve markdown for the target website."
inputs = { api_capabilities = "ApiCapabilities" }
output = "OperationToAccomplish"


[pipe.extract_openapi_info]
type = "PipeLLM"
description = """
Extracts relevant information (e.g., paths, methods) from the OpenAPI JSON specification that pertains to the operation to accomplish.
"""
inputs = { openapi_json_spec = "OpenapiJsonSpec", operation_to_accomplish = "OperationToAccomplish" }
output = "RelevantOpenapiPaths"
model = "llm_to_retrieve"
system_prompt = """
Extract relevant information from the OpenAPI JSON specification that pertains to the operation to accomplish. Provide the information in a structured format.
"""
prompt = """
Extract relevant paths and methods from the OpenAPI JSON specification that are related to the operation to accomplish: `$operation_to_accomplish`. Use the OpenAPI JSON specification: `@openapi_json_spec`. Provide the extracted information in a structured format.
"""

[pipe.determine_function_name]
type = "PipeLLM"
description = "Uses the operation to accomplish and relevant OpenAPI paths to determine the function name."
inputs = { operation_to_accomplish = "OperationToAccomplish", relevant_openapi_info = "RelevantOpenapiPaths" }
output = "FunctionName"
model = "llm_to_answer_questions_cheap"
system_prompt = """
Determine a function name based on the operation to accomplish and relevant OpenAPI paths. Be concise.
"""
prompt = """
Based on the operation `$operation_to_accomplish` and the relevant OpenAPI paths `@relevant_openapi_info`, determine a suitable function name. Provide a single function name.
"""

[pipe.determine_function_parameters]
type = "PipeLLM"
description = "Based on the OpenAPI JSON spec and the operation, identifies the necessary function parameters."
inputs = { openapi_json_spec = "OpenapiJsonSpec", relevant_openapi_info = "RelevantOpenapiPaths", operation_to_accomplish = "OperationToAccomplish" }
output = "FunctionParameters"
model = "llm_to_answer_questions"
system_prompt = """
Generate a list of function parameters based on the OpenAPI JSON specification and the operation to accomplish. Be concise and focus on the necessary parameters.
"""
prompt = """
Based on the OpenAPI JSON specification `@openapi_json_spec` and the operation `$operation_to_accomplish`, identify the necessary function parameters from the relevant OpenAPI paths `@relevant_openapi_info`. Provide the parameters in a structured format.
"""

[pipe.refine_parameters]
type = "PipeLLM"
description = "Optionally refine or format the function parameters for clarity or compatibility."
inputs = { function_parameters = "FunctionParameters" }
output = "RefinedFunctionParameters"
model = "llm_for_writing_cheap"
system_prompt = """
Refine the function parameters to ensure clarity and compatibility. The goal is to format the parameters in a way that makes them easy to understand and work with.
"""
prompt = """
Refine the following function parameters: @function_parameters. Provide the refined parameters in a clear and concise format.
"""

[pipe.compile_function_info]
type = "PipeLLM"
description = "Combines the function name and parameters into a usable format."
inputs = { function_name = "FunctionName", refined_function_parameters = "RefinedFunctionParameters" }
output = "CompiledFunctionInfo"
model = "llm_for_writing_cheap"
system_prompt = """
Generate a structured object containing the compiled function information, including the function name and parameters.
"""
prompt = """
Create a JSON object with the function name as "$function_name" and the function parameters as "$refined_function_parameters".
"""




